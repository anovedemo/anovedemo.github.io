<?xml version="1.0" encoding="utf-8"?>
<draftsman project-name="Demo" xmlns="https://tracepaper.draftsman.io">
	<global>
		<pattern name="IndustryLink" regex="^{{IndustryArn}}(;{{IndustryArn}})*$"></pattern>
		<pattern name="ControlFrameworkArn" regex="^controlframework:[a-z0-9]+$"></pattern>
		<pattern name="CompanyArn" regex="^company:[a-z]+$"></pattern>
		<pattern name="IndustryArn" regex="^industry:[a-z]+$"></pattern>
		<pattern name="ControlFrameworkType" regex="^(standard|regulation|framework)$"></pattern>
	</global>
	<events>
		<event graphql-namespace="ControlFramework.Requirement" graphql-name="add" name="AddControlFrameworkRequirementRequested" authorization="role" role="administrator" type="ActorEvent">
			<field name="arn" type="String" pattern="{{ControlFrameworkArn}}"></field>
			<nested-object name="requirements">
				<field name="name" type="String"></field>
				<field name="description" type="String"></field>
				<field name="mandatory" type="Boolean"></field>
				<field name="summary" type="String"></field>
			</nested-object>
		</event>
		<event graphql-namespace="Industry" graphql-name="add" name="AddIndustryRequested" authorization="role" type="ActorEvent" role="administrator">
			<field name="arn" type="String" pattern="{{IndustryArn}}"></field>
			<field name="name" type="String"></field>
			<field name="description" type="String"></field>
		</event>
		<event graphql-namespace="Company" graphql-name="create" name="CreateCompanyRequested" authorization="authenticated" type="ActorEvent">
			<field name="arn" type="String" pattern="{{CompanyArn}}"></field>
			<field name="name" type="String"></field>
			<field name="description" type="String"></field>
			<field name="companySize" type="Int"></field>
			<field name="revenue" type="String"></field>
			<field name="industry" type="String" pattern="{{IndustryLink}}"></field>
		</event>
		<event graphql-namespace="ControlFramework" graphql-name="add" name="AddControlFrameworkRequested" authorization="role" type="ActorEvent" role="administrator">
			<field name="arn" type="String" pattern="{{ControlFrameworkArn}}"></field>
			<field name="description" type="String"></field>
			<field name="name" type="String"></field>
			<field name="category" type="String" pattern="{{ControlFrameworkType}}"></field>
			<field name="edition" type="String"></field>
			<field name="unit" type="String"></field>
			<field name="acronym" type="String"></field>
			<field name="active" type="Boolean"></field>
			<nested-object name="requirements">
				<field name="name" type="String"></field>
				<field name="description" type="String"></field>
				<field name="mandatory" type="Boolean"></field>
				<field name="summary" type="String"></field>
			</nested-object>
		</event>
		<event name="IndustryCreated" source="Admin.Industry" type="DomainEvent">
			<field name="arn" type="String"></field>
			<field name="name" type="String"></field>
			<field name="description" type="String"></field>
		</event>
		<event name="ControlFrameworkRequirementsAdded" source="Admin.ControlFramework" type="DomainEvent">
			<field name="arn" type="String"></field>
			<nested-object name="requirements">
				<field name="name" type="String"></field>
				<field name="description" type="String"></field>
				<field name="mandatory" type="Boolean"></field>
				<field name="summary" type="String"></field>
			</nested-object>
		</event>
		<event name="ControlFrameworkCreated" source="Admin.ControlFramework" type="DomainEvent">
			<field name="arn" type="String"></field>
			<field name="description" type="String"></field>
			<field name="name" type="String"></field>
			<field name="category" type="String"></field>
			<field name="edition" type="String"></field>
			<field name="unit" type="String"></field>
			<field name="acronym" type="String"></field>
			<field name="active" type="Boolean"></field>
			<nested-object name="requirements">
				<field name="name" type="String"></field>
				<field name="description" type="String"></field>
				<field name="mandatory" type="Boolean"></field>
				<field name="summary" type="String"></field>
			</nested-object>
		</event>
		<event name="CompanyCreated" source="Customer.Company" type="DomainEvent">
			<field name="arn" type="String"></field>
			<field name="name" type="String"></field>
			<field name="description" type="String"></field>
			<field name="companySize" type="Int"></field>
			<field name="revenue" type="String"></field>
			<field name="industry" type="String"></field>
		</event>
	</events>
	<domain>
		<subdomain name="Admin">
			<aggregate name="Industry" business-key="fieldName" event-ttl="-1" snapshot-interval="100" backup-interval-days="0" backup-ttl-days="0">
				<field name="arn" type="String"></field>
				<field name="name" type="String"></field>
				<field name="description" type="String"></field>
				<command name="Create" create-command="true">
					<trigger source="AddIndustryRequested" key-field="arn">
						<mapping target="arn" value="arn"></mapping>
						<mapping target="name" value="name"></mapping>
						<mapping target="description" value="description"></mapping>
					</trigger>
					<processor type="emit-event" id="U8J057" ref="IndustryCreated">
						<mapping target="arn" value="#flow.arn"></mapping>
						<mapping target="name" value="#flow.name"></mapping>
						<mapping target="description" value="#flow.description"></mapping>
					</processor>
					<processor type="validator" id="r8n5VM" condition='flow.name != ""' exception="Name may not be empty"></processor>
					<processor type="validator" id="1HirZZ" condition='flow.description != ""' exception="Description may not be empty"></processor>
					<test-case name="AddNewIndustry" trigger-event="AddIndustryRequested">
						<input name="arn" value="industry:automotive" type="String"></input>
						<input name="name" value="Automotive" type="String"></input>
						<input name="description" value="The automotive industry" type="String"></input>
						<expected domain-event="IndustryCreated">
							<field value="industry:automotive" name="arn" type="String"></field>
							<field value="Automotive" name="name" type="String"></field>
							<field value="The automotive industry" name="description" type="String"></field>
						</expected>
						<expected-state pk="industry:automotive">{
  "arn": "industry:automotive",
  "name": "Automotive",
  "description": "The automotive industry"
}</expected-state>
					</test-case>
					<test-case name="AddDuplicateIndustry" trigger-event="AddIndustryRequested" expected-processing-status="error">
						<input name="arn" value="industry:automotive" type="String"></input>
						<input name="name" value="Hello World!" type="String"></input>
						<input name="description" value="None" type="String"></input>
						<state>{
  "arn": "industry:automotive",
  "name": "Automotive",
  "description": "The automotive industry",
      "version": 1
}</state>
					</test-case>
				</command>
				<event-handler on="IndustryCreated">
					<mapping target="arn" operand="set" value="arn"></mapping>
					<mapping target="name" operand="set" value="name"></mapping>
					<mapping target="description" operand="set" value="description"></mapping>
				</event-handler>
			</aggregate>
			<aggregate name="ControlFramework" business-key="arn" event-ttl="-1" snapshot-interval="100" backup-interval-days="0" backup-ttl-days="0">
				<field name="arn" type="String"></field>
				<field name="description" type="String"></field>
				<field name="name" type="String"></field>
				<field name="category" type="String"></field>
				<field name="edition" type="String"></field>
				<field name="unit" type="String"></field>
				<field name="acronym" type="String"></field>
				<field name="active" type="Boolean"></field>
				<command name="Create" create-command="true">
					<trigger source="AddControlFrameworkRequested" key-field="arn">
						<mapping target="arn" value="arn"></mapping>
						<mapping target="description" value="description"></mapping>
						<mapping target="name" value="name"></mapping>
						<mapping target="category" value="category"></mapping>
						<mapping target="edition" value="edition"></mapping>
						<mapping target="unit" value="unit"></mapping>
						<mapping target="acronym" value="acronym"></mapping>
						<mapping target="active" value="active"></mapping>
						<mapping target="requirements" value="requirements"></mapping>
					</trigger>
					<processor type="emit-event" id="SMJwSw" ref="ControlFrameworkCreated">
						<mapping target="arn" value="#flow.arn"></mapping>
						<mapping target="description" value="#flow.description"></mapping>
						<mapping target="name" value="#flow.name"></mapping>
						<mapping target="category" value="#flow.category"></mapping>
						<mapping target="edition" value="#flow.edition"></mapping>
						<mapping target="unit" value="#flow.unit"></mapping>
						<mapping target="acronym" value="#flow.acronym"></mapping>
						<mapping target="active" value="#flow.active"></mapping>
						<mapping target="requirements" value="#flow.requirements"></mapping>
					</processor>
					<processor type="validator" id="RUrSia" condition='flow.name != ""' exception="Name may not be empty"></processor>
					<test-case name="AddControlFramework" trigger-event="AddControlFrameworkRequested">
						<input name="arn" value="controlframework:mycontrol" type="String"></input>
						<input name="description" value="n.v.t." type="String"></input>
						<input name="name" value="my control" type="String"></input>
						<input name="category" value="framework" type="String"></input>
						<input name="edition" value="1.0" type="String"></input>
						<input name="unit" value="n.v.t." type="String"></input>
						<input name="acronym" value="NVT" type="String"></input>
						<input name="active" value="True" type="Boolean"></input>
						<input name="requirements" type="NestedObject">[
  {
    "name": "myreq",
    "description": "Hello World",
    "mandatory": true,
    "summary": "hello"
  }
]</input>
						<expected domain-event="ControlFrameworkCreated">
							<field value="controlframework:mycontrol" name="arn" type="String"></field>
						</expected>
						<expected-state pk="controlframework:mycontrol">{
  "arn": "controlframework:mycontrol",
  "description": "n.v.t.",
  "name": "my control",
  "category": "framework",
  "edition": "1.0",
  "unit": "n.v.t.",
  "acronym": "NVT",
  "active": true,
  "requirements": {
    "myreq": {
      "name": "myreq",
      "description": "Hello World",
      "mandatory": true,
      "summary": "hello"
    }
  }
}</expected-state>
					</test-case>
					<test-case name="AddDuplicateControlFramework" trigger-event="AddControlFrameworkRequested" expected-processing-status="error">
						<state>{
  "arn": "controlframework:mycontrol",
        "version": 1
}</state>
						<input name="arn" value="controlframework:mycontrol" type="String"></input>
						<input name="description" value="n.v.t." type="String"></input>
						<input name="name" value="my control" type="String"></input>
						<input name="category" value="framework" type="String"></input>
						<input name="edition" value="1.0" type="String"></input>
						<input name="unit" value="n.v.t." type="String"></input>
						<input name="acronym" value="NVT" type="String"></input>
						<input name="active" value="True" type="Boolean"></input>
						<input name="requirements" type="NestedObject">[
  {
    "name": "myreq",
    "description": "Hello World"
  }
]</input>
					</test-case>
				</command>
				<command name="AddRequirements">
					<trigger source="AddControlFrameworkRequirementRequested" key-field="arn">
						<mapping target="arn" value="arn"></mapping>
						<mapping target="requirements" value="requirements"></mapping>
					</trigger>
					<processor type="emit-event" id="VLFqeG" ref="ControlFrameworkRequirementsAdded">
						<mapping target="arn" value="#flow.arn"></mapping>
						<mapping target="requirements" value="#flow.requirements"></mapping>
					</processor>
					<processor type="validator" id="rj33T8" condition="flow.entity.version != 0" exception="Controlframework {flow.arn} is not present in the eventstore"></processor>
					<test-case name="AddNewRequirements" trigger-event="AddControlFrameworkRequirementRequested">
						<input name="arn" value="controlframework:framework" type="String"></input>
						<input name="requirements" type="NestedObject">[
  {
    "name": "myreq",
    "description": "123",
    "mandatory": true,
    "summary": "Hello world!"
  }
]</input>
						<state>{
  "version": 1
}</state>
						<expected domain-event="ControlFrameworkRequirementsAdded">
							<field value="controlframework:framework" name="arn" type="String"></field>
						</expected>
						<expected-state pk="controlframework:framework">{
  "requirements": {
    "myreq":  {
    "name": "myreq",
    "description": "123",
    "mandatory": true,
    "summary": "Hello world!"
  }
  }
}</expected-state>
					</test-case>
				</command>
				<event-handler on="ControlFrameworkRequirementsAdded">
					<nested-mapping source="requirements" target="requirements" business-key="name">
						<mapping target="name" operand="set" value="name"></mapping>
						<mapping target="description" operand="set" value="description"></mapping>
						<mapping target="mandatory" operand="set" value="mandatory"></mapping>
						<mapping target="summary" operand="set" value="summary"></mapping>
					</nested-mapping>
				</event-handler>
				<event-handler on="ControlFrameworkCreated">
					<mapping target="arn" operand="set" value="arn"></mapping>
					<mapping target="description" operand="set" value="description"></mapping>
					<mapping target="name" operand="set" value="name"></mapping>
					<mapping target="category" operand="set" value="category"></mapping>
					<mapping target="edition" operand="set" value="edition"></mapping>
					<mapping target="unit" operand="set" value="unit"></mapping>
					<mapping target="acronym" operand="set" value="acronym"></mapping>
					<mapping target="active" operand="set" value="active"></mapping>
					<nested-mapping source="requirements" target="requirements" business-key="name">
						<mapping target="name" operand="set" value="name"></mapping>
						<mapping target="description" operand="set" value="description"></mapping>
						<mapping target="mandatory" operand="set" value="mandatory"></mapping>
						<mapping target="summary" operand="set" value="summary"></mapping>
					</nested-mapping>
				</event-handler>
				<nested-object name="requirements" business-key="name">
					<field name="name" type="String"></field>
					<field name="description" type="String"></field>
					<field name="mandatory" type="Boolean"></field>
					<field name="summary" type="String"></field>
				</nested-object>
			</aggregate>
		</subdomain>
		<subdomain name="Customer">
			<aggregate name="Company" business-key="name" event-ttl="-1" snapshot-interval="100" backup-interval-days="0" backup-ttl-days="0">
				<field name="arn" type="String"></field>
				<field name="name" type="String"></field>
				<field name="description" type="String"></field>
				<field name="companySize" type="Int"></field>
				<field name="revenue" type="String"></field>
				<field name="industryLink" type="StringList"></field>
				<command name="Create">
					<trigger source="CreateCompanyRequested" key-field="arn">
						<mapping target="arn" value="arn"></mapping>
						<mapping target="name" value="name"></mapping>
						<mapping target="description" value="description"></mapping>
						<mapping target="companySize" value="companySize"></mapping>
						<mapping target="revenue" value="revenue"></mapping>
						<mapping target="industry" value="industry"></mapping>
					</trigger>
					<processor type="emit-event" id="AqKpZH" ref="CompanyCreated">
						<mapping target="arn" value="#flow.arn"></mapping>
						<mapping target="name" value="#flow.name"></mapping>
						<mapping target="description" value="#flow.description"></mapping>
						<mapping target="companySize" value="#flow.companySize"></mapping>
						<mapping target="revenue" value="#flow.revenue"></mapping>
						<mapping target="industry" value="#flow.industry"></mapping>
					</processor>
					<test-case name="CreateNewCompany" trigger-event="CreateCompanyRequested">
						<input name="arn" value="company:draftsman" type="String"></input>
						<input name="name" value="Draftsman" type="String"></input>
						<input name="description" value="--" type="String"></input>
						<input name="companySize" value="2" type="Int"></input>
						<input name="revenue" value="0" type="String"></input>
						<input name="industry" value="--" type="String"></input>
						<expected domain-event="CompanyCreated">
							<field value="company:draftsman" name="arn" type="String"></field>
							<field value="Draftsman" name="name" type="String"></field>
							<field value="--" name="description" type="String"></field>
							<field value="0" name="revenue" type="String"></field>
						</expected>
					</test-case>
				</command>
				<event-handler on="CompanyCreated" code="self.arn = event.arn|LB|self.name = event.name|LB|self.description = event.description|LB|self.companySize = event.companySize|LB|self.revenue = event.revenue|LB|self.industryLink = event.industry.split(';')"></event-handler>
				<nested-object name="businessUnit" business-key="newField">
					<field name="name" type="String"></field>
					<field name="description" type="String"></field>
				</nested-object>
				<nested-object name="regulations" business-key="name">
					<field name="name" type="String"></field>
					<field name="link" type="String"></field>
				</nested-object>
			</aggregate>
		</subdomain>
	</domain>
	<views>
		<view name="ControlFramework" data-retention-days="-1" exclude-notification="false">
			<field name="arn" type="String" pk="true"></field>
			<field name="description" type="String"></field>
			<field name="name" type="String"></field>
			<field name="category" type="String"></field>
			<field name="edition" type="String"></field>
			<field name="unit" type="String"></field>
			<field name="acronym" type="String"></field>
			<field name="active" type="Boolean"></field>
			<field name="requirements" type="ObjectList" ref="Requirement" authorization="authenticated" foreign-key="arn"></field>
			<snapshot-handler id="1xTQuT" sub-domain="Admin" aggregate="ControlFramework" key-mapping="arn" processor="item">
				<mapping target="arn" operand="set" value="arn"></mapping>
				<mapping target="description" operand="set" value="description"></mapping>
				<mapping target="name" operand="set" value="name"></mapping>
				<mapping target="category" operand="set" value="category"></mapping>
				<mapping target="edition" operand="set" value="edition"></mapping>
				<mapping target="unit" operand="set" value="unit"></mapping>
				<mapping target="acronym" operand="set" value="acronym"></mapping>
				<mapping target="active" operand="set" value="active"></mapping>
				<mapping target="requirements" operand="convert_items" value="requirements" template='{"name": value["name"],"description": value["description"],"mandatory": value["mandatory"],"summary": value["summary"]}'></mapping>
				<delete condition="#snapshot.isDeleted != ''"></delete>
			</snapshot-handler>
			<query graphql-namespace="ControlFramework" field-name="get" type="get" authorization="authenticated"></query>
			<query graphql-namespace="ControlFramework" field-name="filter" type="filter" authorization="authenticated"></query>
		</view>
		<view name="Industry" data-retention-days="-1" exclude-notification="false">
			<field name="arn" type="String" pk="true"></field>
			<field name="name" type="String"></field>
			<field name="description" type="String"></field>
			<snapshot-handler id="RLB0hK" sub-domain="Admin" aggregate="Industry" key-mapping="arn" processor="item">
				<mapping target="arn" operand="set" value="arn"></mapping>
				<mapping target="name" operand="set" value="name"></mapping>
				<mapping target="description" operand="set" value="description"></mapping>
				<delete condition="#snapshot.isDeleted != ''"></delete>
			</snapshot-handler>
			<query graphql-namespace="Industry" field-name="get" type="get" authorization="authenticated"></query>
			<query graphql-namespace="Industry" field-name="filter" type="filter" authorization="authenticated"></query>
		</view>
		<view name="Company" data-retention-days="-1" exclude-notification="false">
			<field name="arn" type="String" pk="true"></field>
			<field name="name" type="String"></field>
			<field name="description" type="String"></field>
			<field name="companySize" type="Int"></field>
			<field name="revenue" type="String"></field>
			<field name="industryLink" type="StringList"></field>
			<snapshot-handler id="a8vzJw" sub-domain="Customer" aggregate="Company" key-mapping="arn" processor="item">
				<mapping target="arn" operand="set" value="arn"></mapping>
				<mapping target="name" operand="set" value="name"></mapping>
				<mapping target="description" operand="set" value="description"></mapping>
				<mapping target="companySize" operand="set" value="companySize"></mapping>
				<mapping target="revenue" operand="set" value="revenue"></mapping>
				<mapping target="industryLink" operand="set" value="industryLink"></mapping>
				<delete condition="#snapshot.isDeleted != ''"></delete>
			</snapshot-handler>
			<query graphql-namespace="Company" field-name="get" type="get" authorization="authenticated"></query>
			<query graphql-namespace="Company" field-name="filter" type="filter" authorization="authenticated"></query>
		</view>
		<view name="Requirement" data-retention-days="-1" exclude-notification="false">
			<field name="name" type="String"></field>
			<field name="description" type="String"></field>
			<field name="mandatory" type="String"></field>
			<field name="summary" type="String"></field>
		</view>
	</views>
	<projections>
	</projections>
	<notifiers>
		<notifier name="InitializeSystemUser">
			<trigger source="@afterDeployment">
				<mapping target="dummy" value="#''"></mapping>
			</trigger>
			<activity type="iam-create-systemuser" fail-silent="true" id="vMB9LZ"></activity>
		</notifier>
	</notifiers>
	<functional-scenarios clean-db="true" clean-iam="false" minimum-event-coverage="80" minimum-view-coverage="80">
	</functional-scenarios>
</draftsman>